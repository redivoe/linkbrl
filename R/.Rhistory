sex = "I_SEX",
regional_office = "SC_RO",
state = "HCFA_ST",
dob = "SC_DOB")
data$w89full <- read_sav(file = "source-data/nltcs1989.sav", col_select = vars$w89full) |>
rename(vars$w89full) |>
mutate(across(.cols = c(dob, regional_office, state), .fns = as.numeric))
data$w89full |> is.na() |> colSums()
# Level 0 appears in 1984
map(data, \(x) x$regional_office |>
as.numeric() |>
unique() |>
sort())
regional_office_levs <- attr(data$w82$regional_office, "labels")
data <- map(data, \(x) mutate(x,
regional_office = factor(regional_office,
levels = regional_office_levs,
labels = names(regional_office_levs))))
data$w82 <- mutate(data$w82,
across(.cols = starts_with("birth"), as.numeric))
data[c("w89", "w89full")] <- map(data[c("w89", "w89full")],
\(x) mutate(x,
birth_day = floor((dob %% 10000)/100),
birth_month = floor(dob/10000),
birth_year = dob %% 100) |>
select(-dob))
data$w89full$sex <- fct_recode(data$w89full$sex, "Female" = "F", "Male" = "M")
# sex is apparently badly coded in w94
data$w94$sex <- fct_recode(data$w94$sex, "Male" = "Female", "Female" = "Male")
data$w89full$sex <- fct_recode(data$w89full$sex, "Female" = "F", "Male" = "M")
# sex is apparently badly coded in w94
data$w94$sex <- fct_recode(data$w94$sex, "Male" = "Female", "Female" = "Male")
library(tidyverse)
library(haven)
data_names <- list.files("source-data", pattern = ".dta", recursive = TRUE, full.names = TRUE)
# ID variable
# SEQ_Y*
# Sex
# I_SEX_Y*
# Regional office
# REGOFF_CC_Y* present in all waves but for the first two, many less NAs in
# L2ROC82_Y82 and L2ROC84_Y84
# State code
# 82, 84: ST_CODE_Y*
# 89: MISSING
# 94: NEWCC_10_E3_Y94
# INFO FROM DATA DICTIONARY
# DICTIONARY FOR LONG TERM CARE 1984 PUBLIC USE SURVEY FILE page 243
# SCREENER LTC-2 (1994) page 700
# CC stands for control card
vars <- list(
"w82" = c(id = "SEQ_Y82",
sex = "I_SEX_Y82",
regional_office = "L2ROC82_Y82",
state = "ST_CODE_Y82",
birth_day = "DOB_DD_Y82",
birth_month = "DOB_MM_Y82",
birth_year = "DOB_YY_Y82"),
"w84" = c(id = "SEQ_Y84",
sex = "I_SEX_Y84",
regional_office = "L2ROC84_Y84",
state = "ST_CODE_Y84"),
"w89" = c(id = "SEQ_Y89",
sex = "I_SEX_Y89",
regional_office = "REGOFF_CC_Y89",
state = "HCFA_ST_Y89",
dob = "SC_DOB_Y89"),
"w94" = c(id = "SEQ_Y94",
sex = "I_SEX_Y94",
# the regional office variables are equal
regional_office = "REGOFF_CC_Y94",
# regional_office = "CM_RO_Y94",
state = "HCFA_ST_Y94",
dob = "BDATE_Y94") # "HCFABDATE"
)
data <- map2(data_names, vars,
\(x, y) read_dta(file = x, col_select = all_of(y)) |>
rename(y)) |>
# mutate(across(.cols = everything(), .fns = as.numeric))) |>
set_names(names(vars))
# older full version of 1989 wave
vars$w89full <- c(id = "SEQ",
sex = "I_SEX",
regional_office = "SC_RO",
state = "HCFA_ST",
dob = "SC_DOB")
data$w89full <- read_sav(file = "source-data/nltcs1989.sav", col_select = vars$w89full) |>
rename(vars$w89full) |>
mutate(across(.cols = c(dob, regional_office, state), .fns = as.numeric))
data$w89full |> is.na() |> colSums()
# Level 0 appears in 1984
map(data, \(x) x$regional_office |>
as.numeric() |>
unique() |>
sort())
regional_office_levs <- attr(data$w82$regional_office, "labels")
data <- map(data, \(x) mutate(x,
regional_office = factor(regional_office,
levels = regional_office_levs,
labels = names(regional_office_levs)),
sex = as_factor(sex)))
data$w82 <- mutate(data$w82,
across(.cols = starts_with("birth"), as.numeric))
data[c("w89", "w89full")] <- map(data[c("w89", "w89full")],
\(x) mutate(x,
birth_day = floor((dob %% 10000)/100),
birth_month = floor(dob/10000),
birth_year = dob %% 100) |>
select(-dob))
data$w89full$sex <- fct_recode(data$w89full$sex, "Female" = "F", "Male" = "M")
# sex is apparently badly coded in w94
data$w94$sex <- fct_recode(data$w94$sex, "Male" = "Female", "Female" = "Male")
data$w94 <- mutate(data$w94,
birth_year = as.numeric(substr(dob, 3, 4)),
birth_month = as.numeric(substr(dob, 5, 6)),
birth_day = as.integer((dob - floor(dob))*100)) |>
select(-dob)
map(data, dim)
data[c("w89", "w89full")] <- map(data[c("w89", "w89full")],
\(x) mutate(x,
birth_day = floor((dob %% 10000)/100),
birth_month = floor(dob/10000),
birth_year = dob %% 100,
.after = sex) |>
select(-dob))
data_names <- list.files("source-data", pattern = ".dta", recursive = TRUE, full.names = TRUE)
vars <- list(
"w82" = c(id = "SEQ_Y82",
sex = "I_SEX_Y82",
regional_office = "L2ROC82_Y82",
state = "ST_CODE_Y82",
birth_day = "DOB_DD_Y82",
birth_month = "DOB_MM_Y82",
birth_year = "DOB_YY_Y82"),
"w84" = c(id = "SEQ_Y84",
sex = "I_SEX_Y84",
regional_office = "L2ROC84_Y84",
state = "ST_CODE_Y84"),
"w89" = c(id = "SEQ_Y89",
sex = "I_SEX_Y89",
regional_office = "REGOFF_CC_Y89",
state = "HCFA_ST_Y89",
dob = "SC_DOB_Y89"),
"w94" = c(id = "SEQ_Y94",
sex = "I_SEX_Y94",
# the regional office variables are equal
regional_office = "REGOFF_CC_Y94",
# regional_office = "CM_RO_Y94",
state = "HCFA_ST_Y94",
dob = "BDATE_Y94") # "HCFABDATE"
)
data <- map2(data_names, vars,
\(x, y) read_dta(file = x, col_select = all_of(y)) |>
rename(y)) |>
# mutate(across(.cols = everything(), .fns = as.numeric))) |>
set_names(names(vars))
# older full version of 1989 wave
vars$w89full <- c(id = "SEQ",
sex = "I_SEX",
regional_office = "SC_RO",
state = "HCFA_ST",
dob = "SC_DOB")
data$w89full <- read_sav(file = "source-data/nltcs1989.sav", col_select = vars$w89full) |>
rename(vars$w89full) |>
mutate(across(.cols = c(dob, regional_office, state), .fns = as.numeric))
data$w89full |> is.na() |> colSums()
# Level 0 appears in 1984
map(data, \(x) x$regional_office |>
as.numeric() |>
unique() |>
sort())
regional_office_levs <- attr(data$w82$regional_office, "labels")
data <- map(data, \(x) mutate(x,
regional_office = factor(regional_office,
levels = regional_office_levs,
labels = names(regional_office_levs)),
sex = as_factor(sex)))
data$w82 <- mutate(data$w82,
across(.cols = starts_with("birth"), as.numeric))
data[c("w89", "w89full")] <- map(data[c("w89", "w89full")],
\(x) mutate(x,
birth_day = floor((dob %% 10000)/100),
birth_month = floor(dob/10000),
birth_year = dob %% 100,
.after = sex) |>
select(-dob))
data$w89full$sex <- fct_recode(data$w89full$sex, "Female" = "F", "Male" = "M")
# sex is apparently badly coded in w94
data$w94$sex <- fct_recode(data$w94$sex, "Male" = "Female", "Female" = "Male")
data$w94 <- mutate(data$w94,
birth_year = as.numeric(substr(dob, 3, 4)),
birth_month = as.numeric(substr(dob, 5, 6)),
birth_day = as.integer((dob - floor(dob))*100)) |>
select(-dob)
map(data, dim)
map(data, colnames)
data$w89full
map(data, colnames)
# older full version of 1989 wave
vars$w89full <- c(id = "SEQ",
sex = "I_SEX",
regional_office = "SC_RO",
state = "HCFA_ST",
dob = "SC_DOB")
data$w89full <- read_sav(file = "source-data/nltcs1989.sav", col_select = vars$w89full) |>
rename(vars$w89full) |>
mutate(across(.cols = c(dob, regional_office, state), .fns = as.numeric))
data$w89full |> is.na() |> colSums()
vars$w89full
data$w89full |> is.na() |> colSums()
read_sav(file = "source-data/nltcs1989.sav", col_select = vars$w89full) |>
rename(vars$w89full) |>
colnames()
vars$w89full
data$w89full <- read_sav(file = "source-data/nltcs1989.sav", col_select = vars$w89full) |>
select(all_of(vars$w89full)) |>
rename(vars$w89full) |>
mutate(across(.cols = c(dob, regional_office, state), .fns = as.numeric))
read_sav(file = "source-data/nltcs1989.sav", col_select = vars$w89full) |>
select(all_of(vars$w89full)) |>
colnames()
read_sav(file = "source-data/nltcs1989.sav", col_select = vars$w89full) |>
select(all_of(vars$w89full)) |>
head()
data$w89full <- read_sav(file = "source-data/nltcs1989.sav", col_select = vars$w89full) |>
select(all_of(vars$w89full)) |>
mutate(across(.cols = c(dob, regional_office, state), .fns = as.numeric))
data$w89full |> is.na() |> colSums()
data <- map2(data_names, vars,
\(x, y) read_dta(file = x, col_select = all_of(y)) |>
select(y)) |>
# mutate(across(.cols = everything(), .fns = as.numeric))) |>
set_names(names(vars))
data_names <- list.files("source-data", pattern = ".dta", recursive = TRUE, full.names = TRUE)
vars <- list(
"w82" = c(id = "SEQ_Y82",
sex = "I_SEX_Y82",
regional_office = "L2ROC82_Y82",
state = "ST_CODE_Y82",
birth_day = "DOB_DD_Y82",
birth_month = "DOB_MM_Y82",
birth_year = "DOB_YY_Y82"),
"w84" = c(id = "SEQ_Y84",
sex = "I_SEX_Y84",
regional_office = "L2ROC84_Y84",
state = "ST_CODE_Y84"),
"w89" = c(id = "SEQ_Y89",
sex = "I_SEX_Y89",
regional_office = "REGOFF_CC_Y89",
state = "HCFA_ST_Y89",
dob = "SC_DOB_Y89"),
"w94" = c(id = "SEQ_Y94",
sex = "I_SEX_Y94",
# the regional office variables are equal
regional_office = "REGOFF_CC_Y94",
# regional_office = "CM_RO_Y94",
state = "HCFA_ST_Y94",
dob = "BDATE_Y94") # "HCFABDATE"
)
data <- map2(data_names, vars,
\(x, y) read_dta(file = x, col_select = all_of(y)) |>
select(y)) |>
# mutate(across(.cols = everything(), .fns = as.numeric))) |>
set_names(names(vars))
# older full version of 1989 wave
vars$w89full <- c(id = "SEQ",
sex = "I_SEX",
regional_office = "SC_RO",
state = "HCFA_ST",
dob = "SC_DOB")
data <- map2(data_names, vars,
\(x, y) read_dta(file = x, col_select = all_of(y)) |>
select(all_of(y))) |>
# mutate(across(.cols = everything(), .fns = as.numeric))) |>
set_names(names(vars))
library(tidyverse)
library(haven)
data_names <- list.files("source-data", pattern = ".dta", recursive = TRUE, full.names = TRUE)
vars <- list(
"w82" = c(id = "SEQ_Y82",
sex = "I_SEX_Y82",
regional_office = "L2ROC82_Y82",
state = "ST_CODE_Y82",
birth_day = "DOB_DD_Y82",
birth_month = "DOB_MM_Y82",
birth_year = "DOB_YY_Y82"),
"w84" = c(id = "SEQ_Y84",
sex = "I_SEX_Y84",
regional_office = "L2ROC84_Y84",
state = "ST_CODE_Y84"),
"w89" = c(id = "SEQ_Y89",
sex = "I_SEX_Y89",
regional_office = "REGOFF_CC_Y89",
state = "HCFA_ST_Y89",
dob = "SC_DOB_Y89"),
"w94" = c(id = "SEQ_Y94",
sex = "I_SEX_Y94",
# the regional office variables are equal
regional_office = "REGOFF_CC_Y94",
# regional_office = "CM_RO_Y94",
state = "HCFA_ST_Y94",
dob = "BDATE_Y94") # "HCFABDATE"
)
data <- map2(data_names, vars,
\(x, y) read_dta(file = x, col_select = all_of(y)) |>
select(all_of(y))) |>
# mutate(across(.cols = everything(), .fns = as.numeric))) |>
set_names(names(vars))
# older full version of 1989 wave
vars$w89full <- c(id = "SEQ",
sex = "I_SEX",
regional_office = "SC_RO",
state = "HCFA_ST",
dob = "SC_DOB")
data$w89full <- read_sav(file = "source-data/nltcs1989.sav", col_select = vars$w89full) |>
select(all_of(vars$w89full)) |>
mutate(across(.cols = c(dob, regional_office, state), .fns = as.numeric))
data$w89full |> is.na() |> colSums()
# Level 0 appears in 1984
map(data, \(x) x$regional_office |>
as.numeric() |>
unique() |>
sort())
regional_office_levs <- attr(data$w82$regional_office, "labels")
data <- map(data, \(x) mutate(x,
regional_office = factor(regional_office,
levels = regional_office_levs,
labels = names(regional_office_levs)),
sex = as_factor(sex)))
data$w82 <- mutate(data$w82,
across(.cols = starts_with("birth"), as.numeric))
data[c("w89", "w89full")] <- map(data[c("w89", "w89full")],
\(x) mutate(x,
birth_day = floor((dob %% 10000)/100),
birth_month = floor(dob/10000),
birth_year = dob %% 100,
.after = sex) |>
select(-dob))
data$w89full$sex <- fct_recode(data$w89full$sex, "Female" = "F", "Male" = "M")
# sex is apparently badly coded in w94
data$w94$sex <- fct_recode(data$w94$sex, "Male" = "Female", "Female" = "Male")
data$w94 <- mutate(data$w94,
birth_year = as.numeric(substr(dob, 3, 4)),
birth_month = as.numeric(substr(dob, 5, 6)),
birth_day = as.integer((dob - floor(dob))*100)) |>
select(-dob)
map(data, colnames)
library(tidyverse)
library(haven)
data_names <- list.files("source-data", pattern = ".dta", recursive = TRUE, full.names = TRUE)
vars <- list(
"w82" = c(id = "SEQ_Y82",
sex = "I_SEX_Y82",
birth_day = "DOB_DD_Y82",
birth_month = "DOB_MM_Y82",
birth_year = "DOB_YY_Y82",
regional_office = "L2ROC82_Y82",
state = "ST_CODE_Y82"),
"w84" = c(id = "SEQ_Y84",
sex = "I_SEX_Y84",
regional_office = "L2ROC84_Y84",
state = "ST_CODE_Y84"),
"w89" = c(id = "SEQ_Y89",
sex = "I_SEX_Y89",
regional_office = "REGOFF_CC_Y89",
state = "HCFA_ST_Y89",
dob = "SC_DOB_Y89"),
"w94" = c(id = "SEQ_Y94",
sex = "I_SEX_Y94",
# the regional office variables are equal
regional_office = "REGOFF_CC_Y94",
# regional_office = "CM_RO_Y94",
state = "HCFA_ST_Y94",
dob = "BDATE_Y94") # "HCFABDATE"
)
data <- map2(data_names, vars,
\(x, y) read_dta(file = x, col_select = all_of(y)) |>
select(all_of(y))) |>
# mutate(across(.cols = everything(), .fns = as.numeric))) |>
set_names(names(vars))
# older full version of 1989 wave
vars$w89full <- c(id = "SEQ",
sex = "I_SEX",
regional_office = "SC_RO",
state = "HCFA_ST",
dob = "SC_DOB")
data$w89full <- read_sav(file = "source-data/nltcs1989.sav", col_select = vars$w89full) |>
select(all_of(vars$w89full)) |>
mutate(across(.cols = c(dob, regional_office, state), .fns = as.numeric))
data$w89full |> is.na() |> colSums()
# Level 0 appears in 1984
map(data, \(x) x$regional_office |>
as.numeric() |>
unique() |>
sort())
regional_office_levs <- attr(data$w82$regional_office, "labels")
data <- map(data, \(x) mutate(x,
regional_office = factor(regional_office,
levels = regional_office_levs,
labels = names(regional_office_levs)),
sex = as_factor(sex)))
data$w82 <- mutate(data$w82,
across(.cols = starts_with("birth"), as.numeric))
data[c("w89", "w89full")] <- map(data[c("w89", "w89full")],
\(x) mutate(x,
birth_day = floor((dob %% 10000)/100),
birth_month = floor(dob/10000),
birth_year = dob %% 100,
.after = sex) |>
select(-dob))
data$w89full$sex <- fct_recode(data$w89full$sex, "Female" = "F", "Male" = "M")
# sex is apparently badly coded in w94
data$w94$sex <- fct_recode(data$w94$sex, "Male" = "Female", "Female" = "Male")
data$w94 <- mutate(data$w94,
birth_year = as.numeric(substr(dob, 3, 4)),
birth_month = as.numeric(substr(dob, 5, 6)),
birth_day = as.integer((dob - floor(dob))*100)) |>
select(-dob)
map(data, colnames)
# comparing w89 and w89 full
map2_lgl(data$w89,
filter(data$w89full, id %in% data$w89$id),
\(x, y) all.equal(c(unlist(x)), c(unlist(x))))
data$w89 <- data$w89full
data$w89full <- NULL
# saving data
wave_year <- c(1982, 1984, 1989, 1994)
nltcs <- map2(data, wave_year, \(x, y) mutate(x, wave = y, .before = 1)) |>
bind_rows()
save(file = "nltcs-unique.RData", list = "nltcs")
sep_file_names <- paste0("nltcs", substr(wave_year, 3, 4))
map2(sep_file_names, data, \(x, y) assign(x = x, value = y, envir = .GlobalEnv))
save(file = "nltcs-sep.RData", list = sep_file_names)
setwd("~/Desktop/Linking the Comparison and Graphical Approaches to Bipartite Matching/application-nltcs")
library(tidyverse)
library(Matrix)
library(linkbrl)
load("nltcs-sep.RData")
nltcs_treated <- map(list(nltcs82, nltcs89),
\(x) x |>
drop_na() |>
mutate(across(c(sex, regional_office), as.integer)))
map(nltcs_treated, colnames)
id <- map(nltcs_treated, \(x) pull(x, id))
nltcs_treated <- map(list(nltcs82, nltcs89),
\(x) x |>
drop_na() |>
mutate(across(c(sex, regional_office), as.integer)))
id <- map(nltcs_treated, \(x) pull(x, id))
X <- map(nltcs_treated, \(x) as.matrix(select(x, -id)))
Delta <- +outer(id[[1]], id[[2]], FUN = "==") |>
as(Class = "TsparseMatrix")
setwd("~/Desktop/NLTCS Process")
source("~/Desktop/NLTCS Process/preprocess-nltcs.R")
source("~/Desktop/Linking the Comparison and Graphical Approaches to Bipartite Matching/application-nltcs/nltcs-linking.R")
binary_metrics(Delta = Delta, Delta_hat = out_comp$Delta)
set.seed(2)
out_graph <- brl_cem(X1 = X[[1]], X2 = X[[2]],
model = "graph",
a_prop = 2, b_prop = 2,
a_beta = 1, b_beta = 1,
reps = 10)
library(tidyverse)
library(Matrix)
library(linkbrl)
load("nltcs-sep.RData")
nltcs_treated <- map(list(nltcs82, nltcs89),
\(x) x |>
drop_na() |>
mutate(across(c(sex, regional_office), as.integer)))
setwd("~/Desktop/Linking the Comparison and Graphical Approaches to Bipartite Matching/application-nltcs")
library(tidyverse)
library(Matrix)
library(linkbrl)
load("nltcs-sep.RData")
nltcs_treated <- map(list(nltcs82, nltcs89),
\(x) x |>
drop_na() |>
mutate(across(c(sex, regional_office), as.integer)))
id <- map(nltcs_treated, \(x) pull(x, id))
X <- map(nltcs_treated, \(x) as.matrix(select(x, -id)))
rm(list = setdiff(ls(), c("X", "id")))
Delta <- +outer(id[[1]], id[[2]], FUN = "==") |>
as(Class = "TsparseMatrix")
set.seed(2)
out_graph <- brl_cem(X1 = X[[1]], X2 = X[[2]],
model = "graph",
a_prop = 2, b_prop = 2,
a_beta = 1, b_beta = 1,
reps = 10)
X1 = X[[1]]
X2 = X[[2]]
model = "graph"
brl_cem |> View()
foo <- switch(model,
"graph" = graph_brl_cem,
"fs" = fs_brl_cem)
out_recode <- linkbrl:::recode_columns(X1, X2)
out_recode <- recode_columns(X1, X2)
X1 <- out_recode$X1
X2 <- out_recode$X2
comp_data <- list()
how <- switch(model,
"graph" = "value",
"fs"    = "binary")
comp_data <- list()
comp_data$Gamma <- compare_binary(X1, X2, how, candidate_pairs)
comp_data$Gamma <- linkbrl:::compare_binary(X1, X2, how, candidate_pairs)
candidate_pairs <- NULL
comp_data <- list()
comp_data$Gamma <- linkbrl:::compare_binary(X1, X2, how, candidate_pairs)
setwd("~/Desktop/Linking the Comparison and Graphical Approaches to Bipartite Matching/linkbrl/R")
